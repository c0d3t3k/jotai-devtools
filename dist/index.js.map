{"version":3,"file":"index.js","sources":["../src/JotaiDevtools.tsx"],"sourcesContent":["// import * as R from 'ramda';\n\nimport { useAtom, WritableAtom } from 'jotai'\nimport { Observable, Subject, of } from 'rxjs';\nimport { map, switchMap, filter, catchError } from 'rxjs/operators';\nimport { useObservable, useSubscription } from 'observable-hooks'\n\nimport moment from 'moment';\nimport { useState } from 'react';\nimport { useLifecycles } from 'react-use';\n\ninterface Config {\n    instanceID?: number,\n    name?: string,\n    serialize?: boolean,\n    actionCreators?: any,\n    latency?: number,\n    predicate?: any,\n    autoPause?: boolean\n}\n\ninterface Message {\n    type: string,\n    payload?: any,\n    state?: any\n}\n\ninterface IConnectionResult {\n    subscribe: (dispatch: any) => {};\n    unsubscribe: () => {};\n    send: (action: string, state: any) => {};\n    error: (payload: any) => {};\n}\n\ntype ConnectionResult = IConnectionResult & Observable<Message>\n\ninterface Extension {\n    connect: (options?: Config) => ConnectionResult;\n}\n\n\n\ninterface JotaiDevtoolsProps {\n    atom: WritableAtom<any, any>,\n    name?: string,\n    config?: Config\n}\n\nconst wrapConnectionResult = (result: ConnectionResult) => {\n    const subject = new Subject<Message>()\n\n    result.subscribe(\n        (x: any) => subject.next(x),\n        (x: any) => subject.error(x),\n        () => {subject.complete()}\n    );\n\n    return subject;\n}\n\nexport const useJotaiDevtools = ({ atom, name, config, ...props }: JotaiDevtoolsProps) => {\n\n    const options = {\n        ...config,\n        name\n    }\n\n    const [atomCurrentValue, setAtom] = useAtom(atom);\n\n    // Use hook to pipe value of atom to observable.\n    const atom$ = useObservable((input$) => input$.pipe(\n        map(([x]) => x)\n    ), [atomCurrentValue]);\n \n    // Flag determines whether the last state update was a 'Time Travel' event\n    const [wasTriggeredByDevtools, setWasTriggeredByDevtools] = useState(() => false);\n\n    // Flag determines whether initial state has already been sent to DevTools extension\n    const [sentInitialState, setSentInitialState] = useState(() => false);\n\n    const [devTools, setDevTools] = useState<ConnectionResult>();\n\n    // This observable hook provides a sanitized observable of DevTools extension events\n    const devTools$ = useObservable((input$) => input$.pipe(\n        filter(([x]) => !!x),\n        switchMap(([x]) => wrapConnectionResult(x as ConnectionResult)),\n        catchError((error, observable) => {\n            console.error(error);\n            return observable;\n        })\n    ), [devTools]);\n\n    // Function handles State Jumps and Time Traveling\n    const jumpToState = (newState: any) => {\n        setWasTriggeredByDevtools(true)\n        // var oldState = atomCurrentValue();\n        setAtom(newState);\n        // setWasTriggeredByDevtools(false);\n    };\n\n    // Hook for subscribing to DevTools extension events\n    useSubscription(devTools$, (message) => {\n        switch (message.type) {\n            case 'START':\n                console.log(\"Atom Devtools Start\", options.name, atomCurrentValue)\n                if(!sentInitialState) {\n                    // devTools.send(\"\\\"\" + options.name + \"\\\" - Initial State\", atom.getState());\n                    devTools?.send(name + \" - Initial State\", atomCurrentValue);\n                    setSentInitialState(true);\n                }\n                return;\n            case 'DISPATCH':\n                if (!message.state) {\n                    return;\n                }\n                switch (message.payload.type) {\n                    case 'JUMP_TO_ACTION':\n                    case 'JUMP_TO_STATE':\n                        jumpToState(JSON.parse(message.state));\n                        return;\n                }\n                return;\n        }\n    });\n\n    // Subscription to Atom state changes\n    useSubscription(atom$, (state) => {\n        if (wasTriggeredByDevtools) {\n            setWasTriggeredByDevtools(false);\n            return;\n        }\n        devTools?.send(name + \" - \" + moment().toISOString(), state);\n    })\n\n    // Initial life cycle event to connect to DevTools Extension\n    const initDevtools = () => {\n        const devtools = (window as any).__REDUX_DEVTOOLS_EXTENSION__ as Extension;\n        // const options = config;\n        const name = options.name || window.document.title;\n\n        if (!devtools) {\n            console.error('Jotai Devtools plugin: Cannot find Redux Devtools browser extension. Is it installed?');\n            return atom;\n        }\n\n        const devTools = devtools.connect(options);\n        \n        console.log(\"Get Dev Tools\", devTools, of(devTools));\n\n        setDevTools(devTools);\n\n        // setTimeout(() => devTools.send(name + \" - Initial State\", atomCurrentValue), 50)\n\n        return atom;\n    }\n\n    // [React Use Hook]() that fires initialization\n    useLifecycles(() => {\n        initDevtools();\n    });\n}\n\nexport const JotaiDevtools: React.FC<JotaiDevtoolsProps> = (props) => {\n    useJotaiDevtools(props);\n\n    return null;\n}"],"names":["Subject","useAtom","useObservable","map","useState","filter","switchMap","catchError","useSubscription","of","useLifecycles"],"mappings":"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"}